<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MealLog</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/static/sb-admin-2.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/static/clipboard-list-solid.png" type="image/png">
  <style>
    .dashboard-card { min-height: 400px; }
    .dashboard-chart { width: 280px; height: 280px; }
    .chart-wrapper { max-width: 180px; width: 100%; }
    #calendarArea table {
    width: 100%;                /* ì „ì²´ í­ì„ ì±„ìš°ê¸° */
    table-layout: fixed;        /* ì—´ ë„ˆë¹„ ê· ë“± ë¶„ë°° */
    font-size: 11px;
    margin-top: 10px;
    border-collapse: collapse;
  }
  #calendarArea th,
  #calendarArea td {
    padding: 4px;
    vertical-align: top;
    height: 70px;               /* ì„¸ë¡œ ë†’ì´ë¥¼ ì¤„ì„ */
    border: 1px solid #ccc;
  }

  #calendarArea td div {
    margin: 1px 0;
  }

  #calendarArea .meal {
    font-size: 10px;
    margin: 1px 0;
    height: 16px;               /* ì•„/ì /ì € ì„¸ë¡œ ë†’ì´ ì••ì¶• */
    line-height: 16px;
    text-align: center;
    border-radius: 3px;
  }
  </style>
</head>
<body id="page-top">
  <div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
        <div class="sidebar-brand-icon rotate-n-15">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="sidebar-brand-text mx-3">MealLog</div>
      </a>
      <hr class="sidebar-divider my-0" />
      <li class="nav-item"><a class="nav-link" href="/info"><i class="fas fa-fw fa-info-circle"></i><span>Info</span></a></li>
      <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-fw fa-chart-bar"></i><span>Dashboard</span></a></li>
      <li class="nav-item"><a class="nav-link" href="/modify"><i class="fas fa-fw fa-clipboard-list"></i><span>Diets</span></a></li>
      <li class="nav-item"><a class="nav-link" href="/mypage"><i class="fas fa-fw fa-user"></i><span>My Page</span></a></li>
    </ul>

    <!-- Content -->
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/mypage"><i class="fas fa-user"></i> My Page</a>
            </li>
          </ul>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 text-gray-800">ì‹ë‹¨ ê¸°ë¡ ëŒ€ì‹œë³´ë“œ</h1>
            <div>
              <select id="yearSelect" class="form-select form-select-sm d-inline-block mr-2"></select>
              <select id="monthSelect" class="form-select form-select-sm d-inline-block"></select>
            </div>
          </div>

          <div class="row">
            <!-- ê¸°ë¡ í˜„í™© -->
            <div class="col-lg-6 mb-4">
              <div class="card dashboard-card">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">1. ì´ë²ˆ ë‹¬ ê¸°ë¡ í˜„í™©</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                  <p id="monthSummary" class="text-dark font-weight-bold mb-3 text-center"></p>
                  <canvas id="monthProgressChart" class="dashboard-chart"></canvas>
                </div>
              </div>
            </div>

            <!-- ë¼ë‹ˆë³„ ë¹„ìœ¨ -->
            <div class="col-lg-6 mb-4">
              <div class="card dashboard-card">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">2. ë¼ë‹ˆë³„ ë¹„ìœ¨</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                  <p class="text-dark font-weight-bold mb-3 text-center">ì–´ë–¤ ë¼ë‹ˆë¥¼ ì£¼ë¡œ ê¸°ë¡í–ˆëŠ”ì§€ í•œëˆˆì— ë³´ì—¬ì¤˜ìš”</p>
                  <div class="chart-wrapper">
                    <canvas id="mealPieChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- TOP3 ìŒì‹ -->
            <div class="col-lg-6 mb-4">
              <div class="card dashboard-card">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">3. ìì£¼ ë¨¹ì€ ìŒì‹ TOP3</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                  <p class="text-dark font-weight-bold mb-3 text-center">ë‚´ê°€ ê°€ì¥ ìì£¼ ë¨¹ì€ ë©”ë‰´ë¥¼ ì•Œë ¤ì¤˜ìš”</p>
                  <ul id="topFoodsList" class="list-group w-75"></ul>
                </div>
              </div>
            </div>

            <!-- ì¼ë³„ ê¸°ë¡ ì—¬ë¶€ -->
            <div class="col-lg-6 mb-4">
              <div class="card dashboard-card">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">4. ì¼ë³„ ê¸°ë¡ ì—¬ë¶€</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                  <p class="text-dark font-weight-bold mb-3 text-center">ì‹ë‹¨ì„ ê¸°ë¡í•œ ë‚ ê³¼ ë¹ ì§„ ë‚ ì„ í•œëˆˆì— í™•ì¸í•´ìš”</p>
                  <div id="calendarArea" class="text-center">ğŸ“… ìº˜ë¦°ë”ëŠ” ì¶”í›„ ì œê³µ ì˜ˆì •</div>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- container-fluid -->
      </div> <!-- content -->
    </div> <!-- content-wrapper -->
  </div> <!-- wrapper -->

  <script>
    const userId = 1;
    const yearSelect = document.getElementById("yearSelect");
    const monthSelect = document.getElementById("monthSelect");

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    const maxYear = currentYear + 5;

    for (let y = 2025; y <= maxYear; y++) {
      yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}ë…„</option>`;
    }
    for (let m = 1; m <= 12; m++) {
      const padded = m.toString().padStart(2, '0');
      monthSelect.innerHTML += `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${padded}ì›”</option>`;
    }

    let progressChart = null;
    let pieChart = null;

    function loadDashboardData(year, month) {
      console.log(`[DEBUG] ìš”ì²­: year=${year}, month=${month}`);
      fetch(`/dashboard/${userId}?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(data => {
          generateCalendar(year, month, data.daily_meals);
          const percent = (data.monthly_progress.recorded_days / data.monthly_progress.total_days * 100).toFixed(1);
          document.getElementById("monthSummary").textContent =
            `${year}ë…„ ${month}ì›”ì€ ì´ ${data.monthly_progress.total_days}ì¼ ì¤‘ ${data.monthly_progress.recorded_days}ì¼ ê¸°ë¡í–ˆì–´ìš” (${percent}%)`;

          if (progressChart) progressChart.destroy();
          if (pieChart) pieChart.destroy();

          progressChart = new Chart(document.getElementById('monthProgressChart'), {
            type: 'bar',
            data: {
              labels: ['ê¸°ë¡ë¥ (%)'],
              datasets: [{
                label: 'ê¸°ë¡ëœ ë‚  ìˆ˜',
                data: [percent],
                backgroundColor: 'rgba(75, 192, 192, 0.7)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              scales: { y: { beginAtZero: true, max: 100 } },
              plugins: { legend: { display: false } }
            }
          });

          const times = data.meal_time_distribution.map(row => row.time);
          const counts = data.meal_time_distribution.map(row => row.count);

          pieChart = new Chart(document.getElementById('mealPieChart'), {
            type: 'pie',
            data: {
              labels: times,
              datasets: [{
                data: counts,
                backgroundColor: ['#ff9999', '#66b3ff', '#99ff99']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });

          const topList = document.getElementById('topFoodsList');
          topList.innerHTML = '';
          data.top_foods.forEach(food => {
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `<span>${food.menu}</span><span class="badge badge-primary badge-pill">${food.count}íšŒ</span>`;
            topList.appendChild(li);
          });
        });
    }

    yearSelect.addEventListener("change", () => {
      loadDashboardData(parseInt(yearSelect.value), parseInt(monthSelect.value));
    });
    monthSelect.addEventListener("change", () => {
      loadDashboardData(parseInt(yearSelect.value), parseInt(monthSelect.value));
    });

    loadDashboardData(currentYear, currentMonth);
    
    function generateCalendar(year, month, mealData) {
  const calendarArea = document.getElementById("calendarArea");
  calendarArea.innerHTML = "";

  const table = document.createElement("table");
  table.className = "table table-bordered";
  const headerRow = document.createElement("tr");
  ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "].forEach(day => {
    const th = document.createElement("th");
    th.textContent = day;
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  const date = new Date(year, month - 1, 1);
  const startDay = date.getDay();
  const lastDate = new Date(year, month, 0).getDate();

  let currentRow = document.createElement("tr");
  for (let i = 0; i < startDay; i++) {
    currentRow.appendChild(document.createElement("td"));
  }

  for (let day = 1; day <= lastDate; day++) {
    if (currentRow.children.length === 7) {
      table.appendChild(currentRow);
      currentRow = document.createElement("tr");
    }

    const cell = document.createElement("td");
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const record = mealData[dateStr] || { breakfast: 0, lunch: 0, dinner: 0 };

    cell.innerHTML = `
      <div><strong>${day}</strong></div>
      <div class="meal" style="background-color:${record.breakfast ? 'lightgreen' : 'lightcoral'}">ì•„</div>
      <div class="meal" style="background-color:${record.lunch ? 'lightgreen' : 'lightcoral'}">ì </div>
      <div class="meal" style="background-color:${record.dinner ? 'lightgreen' : 'lightcoral'}">ì €</div>
    `;
    currentRow.appendChild(cell);
  }

  while (currentRow.children.length < 7) {
    currentRow.appendChild(document.createElement("td"));
  }

  table.appendChild(currentRow);
  calendarArea.appendChild(table);
}
  </script>
</body>
</html>
